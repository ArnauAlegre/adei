---
title: "Deliverable 1"
author: "Pere Arnau Alegre & Andrés Jiménez González"
date: \today
output:
  word_document:
    toc: no
    toc_depth: '4'
  pdf_document:
    number_sections: yes
    toc: yes
    toc_depth: 4
  html_document:
    toc: no
    toc_depth: '4'
geometry: left=1.9cm,right=1.9cm,top=1.25cm,bottom=1.52cm
fontsize: 18pt
subtitle: Data Processing, Description, Validation and Profiling
classoption: a4paper
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
# Data description
* Description http://www.nyc.gov/html/tlc/html/about/trip_record_data.shtml
* Data Dictionary - SHL Trip Data -This data dictionary describes SHL trip data

## Variables
* Model
  * A string indicating the model of the car.     
* Year	
  * A discrete numeric variable to indicate the year the car was sold
* Price
  * Continuous variable indicating the price at which the car was sold
* Transmission
  * Categorical variable that indicates the type of transmission of the car
  * Values:
    * Automatic
    * Manual
    * Semi-Automatic
    * Other
* Mileage
  * A discrete numeric variable to indicate the number of miles the car had when it was sold
* Fuel Type
  * Categorical variable that indicates the type of fuel of the car
  * Values:
    * Diesel
    * Electric
    * Hybrid
    * Petrol
    * Other
* Tax
  * A discrete numeric variable to indicate the road tax of the vehicle.
* MPG
  *  Continuous variable indicating the fuel consumption of the car
* Engine Size
  * Continuous variable indicating the size of the engine
* Manufacturer
  * Categorical variable that indicates the manufacturer brand of the car.
  * Values:
    * Mercedes
    * Audi
    * Volkswagen
    * BMW


# Loading of Required Packages for the deliverable
We load the necessary packages and set the working directory
```{r echo = T, results = 'hide', message=FALSE, error=FALSE, warning=FALSE}
setwd("C:/Users/Arnau/Desktop/adei/deliverable1")
# Load Required Packages
options(contrasts=c("contr.treatment","contr.treatment"))
requiredPackages <- c("missMDA","chemometrics","mvoutlier","effects","FactoMineR","car", "factoextra","RColorBrewer","dplyr","ggmap","ggthemes","knitr", "corrplot")
missingPackages <- requiredPackages[!(requiredPackages %in% installed.packages()[,"Package"])]
if(length(missingPackages)) install.packages(missingPackages)
lapply(requiredPackages, require, character.only = TRUE)
```  

## Select a sample of 5000 records
From the proposed database, we need to select a sample of 5000 records randomly so we can start analyzing our data.
```{r echo = T, results = 'hide'}
if(!is.null(dev.list())) dev.off()  # Clear plots
rm(list=ls())                       # Clean workspace
```


Data: used_car_dataset.csv
```{r}
filepath<-"C:/Users/Arnau/Desktop/adei/deliverable1"
df<-read.table(paste0(filepath,"/sample_5000.csv"),header=T, sep=",")[c(-1)]

# dim(df)       # Displays the sample size
# names(df)     # Displays the names of the sample variables
# summary(df)   
```

Select your 5000 register sample (random sample)
```{r echo = T, results = 'hide'}
set.seed(123456)
sam<-as.vector(sort(sample(1:nrow(df),5000)))
```

Verification and storage of the sample
```{r}
head(df)
df<-df[sam,]
rownames(df) <- 1:nrow(df) #rename row id's from 1 to nrows
summary(df)
```


## Some useful functions
```{r}
calcQ <- function(x) { # Function to calculate the different quartiles
  s.x <- summary(x)
  iqr<-s.x[5]-s.x[2]
  list(souti=s.x[2]-3*iqr, mouti=s.x[2]-1.5*iqr, min=s.x[1], q1=s.x[2], q2=s.x[3], 
       q3=s.x[5], max=s.x[6], mouts=s.x[5]+1.5*iqr, souts=s.x[5]+3*iqr ) 
}
countNA <- function(x) { # Function to count the NA values
  mis_x <- NULL
  for (j in 1:ncol(x)) {mis_x[j] <- sum(is.na(x[,j])) }
  mis_x <- as.data.frame(mis_x)
  rownames(mis_x) <- names(x)
  mis_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {mis_i <- mis_i + as.numeric(is.na(x[,j])) }
  list(mis_col=mis_x,mis_ind=mis_i) 
}
countX <- function(x,X) { # Function to count a specific number of appearences
  n_x <- NULL
  for (j in 1:ncol(x)) {n_x[j] <- sum(x[,j]==X) }
  n_x <- as.data.frame(n_x)
  rownames(n_x) <- names(x)
  nx_i <- rep(0,nrow(x))
  for (j in 1:ncol(x)) {nx_i <- nx_i + as.numeric(x[,j]==X) }
  list(nx_col=n_x,nx_ind=nx_i) 
}
```

# Variable initialization of missings, outliers and errors
Initialization of counts for missings, outliers and errors. All numerical variables have to be checked before.

```{r}

imis<-rep(0,nrow(df))  # rows - cars
jmis<-rep(0,2*ncol(df))  # columns - variables

mis1<-countNA(df)
mis1$mis_ind # Number of missings for the current set of cars (observations)
mis1$mis_col # Number of missings for the current set of variables

iouts<-rep(0,nrow(df))  # rows - cars
jouts<-rep(0,ncol(df))  # columns - variables

ierrs<-rep(0,nrow(df))  # rows - cars
jerrs<-rep(0,ncol(df))  # columns - variables
```

#Univariate Description and Preprocessing


## Qualitative Variables (Factors) / Categorical
**Description**: Original numeric variables corresponding to qualitative concepts have to be converted to factors. New factors grouping original levels will be considered very positively.
We need to do an analysis of all the variables to be able to identify missings, errors and outliers. 
We will also try to factorize each variable to make it easier to understand the sample.

### 1. Model
This variable indicates the model of the car.
```{r}
df$model<-factor(paste0(df$manufacturer,"-",df$model))
#levels(df$model)
summary(df$model)
#Too many models to represent them in a graph
#The is not missing data or erroneous data, so we will not make any change in the model column
```

### 2. Year
A discrete numeric variable to indicate the year the car was sold, ranging from 1970 to 2020

#### Factorization and outlier detection of the variable year
```{r}
boxplot(df$year, main="Boxplot of sold year", col="darkslateblue")
#df$year <- factor(df$year)
#We can see that there are outliers in the dataset, so we will treat them.
summary(df$year)
var_out<-calcQ(df$year)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

llout<-which((df$year <= var_out$souti))
iouts[llout] <- iouts[llout]+1
jouts[which(colnames(df)=="year")]<-length(llout)

#We will group all the inferior outliers into one variable
df[llout,"year"] <- NA
summary(df$year)
#df[which(df$year<=var_out$souti),"year"] <- paste0(var_out$souti, " or before")
barplot(table(df$year), main="Barplot of sold year", col="darkslateblue")
```

### 3. Price
We know that the price should be positive, so we will treat as errors the prices <= 0.
```{r}
summary(df$price)
sel<-which(df$price <= 0)
ierrs[sel] <- ierrs[sel] + 1
jerrs[which(colnames(df)=="price")] <- length(sel)
#We will delete the rows with errors in the price because we cannot make imputations for our target variable.
df <- df[-sel, ]
```
Non positive values are replaced by NA.
#### Outlier detection
```{r}
boxplot(df$price)
var_out<-calcQ(df$price)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")
#We can see there are outliers in the dataset so we will treat them.
#As this is the response variable, we will delete the outlier rows because we cannot delete the value and impute it.
llout_price<-which((df$price > var_out$souts) | (df$price < var_out$souti ))
#iouts[llout] <- iouts[llout]+1
jouts[which(colnames(df)=="price")]<-length(llout_price)
df <- df[-llout_price, ]
```

In orther to better analyze the price of the cars and to group them, we will create a categorical variable representing the price of the car.
```{r}
df$price_type <- df$price
df$price_type[which(df$price >= var_out$min & df$price_type < var_out$q1)] <- "super cheap"
df$price_type[which(df$price >= var_out$q1 & df$price_type < var_out$q2)] <- "cheap"
df$price_type[which(df$price >= var_out$q2 & df$price_type < var_out$q3)] <- "expensive"
df$price_type[which(df$price >= var_out$q3 & df$price_type < var_out$mouts)] <- "very expensive"
df$price_type[which(df$price >= var_out$mouts )] <- "extremely expensive"
table(df$price_type)
```


### 4. Transmission

```{r}
df$transmission <- factor( df$transmission )
levels( df$transmission )
df$transmission <- factor( df$transmission, levels = c("Manual","Semi-Auto","Automatic"),labels = paste0("f.Trans-",c("Manual","SemiAuto","Automatic")))
#All transmission not listed above have been replaced as NA
```

### 5. Mileage
```{r}
boxplot(df$mileage)
var_out<-calcQ(df$mileage)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")
llout_mil<-which((df$mileage<var_out$souti)|(df$mileage>var_out$souts))
iouts[llout_mil]<-iouts[llout_mil]+1
df[llout_mil,"mileage"] <- NA
```


### 6. fuelType
Andres
```{r}
df$fuelType <- factor(df$fuelType)
levels(df$fuelType)
df$fuelType <- factor( df$fuelType, levels = c("Diesel","Petrol","Hybrid"), labels = paste0("f.Fuel-",c("Diesel","Petrol","Hybrid")))
#All fuelTypes not listed above have been replaced as NA
```


### 7. Tax
Andres
```{r}
boxplot(df$tax, main="Boxplot of tax", col="darkslateblue")
#df$year <- factor(df$year)
#We can see that there are outliers in the dataset, so we will treat them.
summary(df$tax)
var_out<-calcQ(df$tax)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")

llout<-which((df$tax <= var_out$souti & df$tax >= var_out$souts))
iouts[llout] <- iouts[llout]+1
jouts[which(colnames(df)=="tax")]<-length(llout)
df$tax[llout, "tax"] <- NA

summary(df$tax)
boxplot(df$tax)

```

### 8. MPG
Andres
```{r}
#Outliers are replaced by NA
boxplot(df$mpg)
var_out<-calcQ(df$mpg)
abline(h=var_out$souts,col="red")
abline(h=var_out$souti,col="red")
llout_mpg<-which((df$mpg<var_out$souti)|(df$mpg>var_out$souts))
iouts[llout_mpg]<-iouts[llout_mpg]+1
jouts[which(colnames(df)=="mpg")]<-length(llout)
df[llout_mpg,"mpg"] <- NA
```


### 9. EngineSyze
Andres --> contabilizar errores
```{r}
df$engineSize <- factor(df$engineSize)
levels(df$engineSize)

df[which(df[,"engineSize"]==0),]

# It is a quantitive variable  Non-possible values will be recoded to NA
sel<-which(df$engineSize==0)
ierrs[sel]<-ierrs[sel]+1 #Vector of errors per individual update
sel                 #### sel contains the rownames of the individuals with "0" 
#                        as  value for engineSize
# We should update jerrs vector: errors per variable

# df[sel,"engineSize"]<-3    # non-possible values are replaced by NA, missing value symbol in R
# NA assignment for forward imputation:
df[sel,"engineSize"]<-NA
```

#Imputation
What we do with imputation is be able to eliminate all those values that may be missings, outliers or errors to turn them into values that can be realistic within our sample.

## Imputation of numeric variables

```{r}
library(missMDA)
# Now one by one describe vars and put them on lists
vars_con<-c("year", "mileage", "tax", "mpg")
vars_res<-c("price")

summary(df[,vars_con])
res.impca<-imputePCA(df[,vars_con],ncp=3)
summary(res.impca$completeObs)

# Check one by one:
par(mfrow=c(1,2))
hist(df$year)
hist(res.impca$completeObs[,"year"])
hist(df$mileage)
hist(res.impca$completeObs[,"mileage"])
hist(df$tax)
hist(res.impca$completeObs[,"tax"])
hist(df$mpg)
hist(res.impca$completeObs[,"mpg"])

# Once you have validated the process:
df[,vars_con ]<-res.impca$completeObs

```

## Imputation of qualitative variables

```{r}
vars_dis<-c("model","transmission","fuelType","engineSize","manufacturer")
summary(df[,vars_dis])
res.immca<-imputeMCA(df[,vars_dis],ncp=4)
summary(res.immca$completeObs)
# Check one by one (we only have enginesize, transmission & fuelType)
barplot(table(df$engineSize))
barplot(table(res.immca$completeObs[,"engineSize"]))
barplot(table(df$transmission))
barplot(table(res.immca$completeObs[,"transmission"]))
barplot(table(df$fuelType))
barplot(table(res.immca$completeObs[,"fuelType"]))


# Once you have validated the process
df[ , vars_dis ]<-res.immca$completeObs

# Are there NA?
sum(countNA(df)$mis_ind)==0

par(mfrow=c(1,1))
```


# Creation and discretization of new variables

## 1. New variable: Audi/Not Audi
```{r}
# Binary Target: Audi?

df$Audi<-ifelse(df$manufacturer == "Audi",1,0)
df$Audi<-factor(df$Audi,labels=c("No","Yes"))
summary(df$Audi)
# Pie
piepercent<-round(100*(table(df$Audi)/nrow(df)),dig=2); piepercent
pie(table(df$Audi),col=heat.colors(2),labels=paste(piepercent,"%"))
legend("topright", levels(df$Audi), cex = 0.8, fill = heat.colors(2))
# Bar Chart
barplot(table(df$Audi),main="Barplot Binary Outcome - Factor",col=c("red","green"))
```

## 2. New variable: yearsAferSell
A discrete numeric variable to indicate how many years have passed from when the car was sold since 2022.

```{r}
df$years_after_sell <-  2022 - df$year
boxplot(df$years_after_sell, main="Boxplot of years after sell", col="darkslateblue")
#There are no extreme outliers in the variable because we treated outliers in the variable year.
summary(df$years_after_sell)
```

## 3. Variable Tax
```{r}
quantile(df$tax,seq(0,1,0.25),na.rm=TRUE)
quantile(df$tax,seq(0,1,0.1),na.rm=TRUE)
quants <- calcQ(df$tax)

# df$aux<-factor(cut(df$tax,breaks=quantile(df$tax,seq(0,1,0.25),na.rm=TRUE),include.lowest = T )) # Does not work
#Reconsiderations of limits bc mean and 3rd quantile are the same
#aux<-factor(cut(df$tax,breaks=c(0, 125, 145, quants),include.lowest = T ))
#summary(aux)
#tapply(df$tax,aux,median)
df$f.tax<-factor(cut(df$tax, breaks=c(quants$min,quants$q1, quants$q2, quants$q3+10, quants$max), include.lowest=T))
levels(df$f.tax)<-paste("f.tax-",levels(df$f.tax),sep="")
table(df$f.tax,useNA="always")
```

## 4. Variable mileage
```{r}
df$f.mileage<-factor(cut(df$mileage,breaks=c(quantile(df$mileage,seq(0,1,0.25),na.rm=TRUE)),include.lowest = T ))
levels(df$f.mileage)<-paste("f.mileage-",levels(df$f.mileage),sep="")
table(df$f.mileage,useNA="always")
```

## 4. Variable mpg
```{r}
df$f.mpg<-factor(cut(df$mpg,breaks=c(quantile(df$mpg,seq(0,1,0.25),na.rm=TRUE)),include.lowest = T ))
levels(df$f.mpg)<-paste("f.mpg-",levels(df$f.mpg),sep="")
table(df$f.mpg,useNA="always")
```

## 5. Variable year
```{r}
df$f.year<-factor(cut(df$year,breaks=c(quantile(df$year,seq(0,1,0.25),na.rm=TRUE)),include.lowest = T ))
levels(df$f.year)<-paste("f.mpg-",levels(df$f.year),sep="")
table(df$f.year,useNA="always")
```

#Create variable adding the total number missing values, outliers and errors.
Describe these variables, to which other variables exist higher associations.

##Compute the correlation with all other variables. Rank these variables according the correlation
```{r}
df$inconsistencies <- imis+iouts+ierrs
vars_quanti <- c(2,3,5,7,8,9,12)
res <- cor(df[,vars_quanti])
round(res, 2)
corrplot(res)
```

##Mean of missing/outliers/errors per groups
Compute for every group of individuals (group of age, etc, …) the mean of missing/outliers/errors values. Rank the groups according the computed mean.
```{r}
df_aux$vw_inconsists <- mean(df$inconsistencies[ which(df$manufacturer=="VW")])
df_aux$audi_inconsis <- mean(df$inconsistencies[ which(df$manufacturer=="Audi")])
df_aux$bmw_inconsis <- mean(df$inconsistencies[ which(df$manufacturer=="BMW")])
df_aux$merc_inconsis <- mean(df$inconsistencies[ which(df$manufacturer=="Mercedes")])
df_aux <- data.frame("Modelo"=c("Audi", "VM", "Mercedes", "BMW"))
df_aux$incons <- c(vw_inconsists, audi_inconsis, bmw_inconsis, merc_inconsis)
df_aux2<-df_aux[order(df_aux$incons),]
barplot(df_aux2$incons, names.arg = df_aux2$Modelo)

```



